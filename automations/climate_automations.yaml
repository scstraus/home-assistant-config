##################################################
# AUTOMATIONS TO TURN DOWN HEAT FOR OPEN WINDOWS #
##################################################


- id: heat_down_open_living_room_auto
  alias: heat_down_open_living_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.back_door
    to: 'on'
    for: 
      minutes: 3
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.living_room
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile_living_room
    state: 'LIVING_ROOM_AUTO'
        


- id: heat_up_closed_living_room_auto
  alias: heat_up_closed_living_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.back_door
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.living_room
  condition:
    condition: state
    entity_id: input_select.active_heating_profile_living_room
    state: 'LIVING_ROOM_AUTO'


- id: heat_down_open_sophies_room_auto
  alias: heat_down_open_sophies_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.sophies_room_ceiling_window
    to: 'on'
    for: 
      minutes: 3
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.sophie_s_room
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'
#  condition:
#    condition: template 
#    value_template: > 
#      {{ state_attr('climate.living_room', 'status').setpoint_status.setpoint_mode in 'FollowSchedule' }}


- id: heat_up_closed_sophies_room_auto
  alias: heat_up_closed_sophies_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.sophies_room_ceiling_window
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.sophie_s_room
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

- id: heat_down_open_sebastians_room_auto
  alias: heat_down_open_sebastians_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.sebastians_room_left_window
    to: 'on'
    for: 
      minutes: 3
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.sebastian_s_room
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

- id: heat_up_closed_sebastians_room_auto
  alias: heat_up_closed_sebastians_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.sebastians_room_left_window
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.sebastian_s_room
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'


- id: heat_down_open_master_closet_auto
  alias: heat_down_open_master_closet_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.ecolink_closet_left_window
    to: 'on'
    for: 
      minutes: 2
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.master_closet
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

- id: heat_down_open_master_bedroom_auto
  alias: heat_down_open_master_bedroom_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.master_bedroom_window
    to: 'on'
    for: 
      minutes: 2
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.master_bedroom
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

- id: heat_down_open_playroom_auto
  alias: heat_down_open_playroom_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.play_room_terrace_door
    to: 'on'
    for: 
      minutes: 2
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.dining_room
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

#  condition:
#    condition: template 
#    value_template: > 
#      {{ state_attr('climate.living_room', 'status').setpoint_status.setpoint_mode in 'FollowSchedule' }}


- id: heat_up_closed_master_closet_auto
  alias: heat_up_closed_master_closet_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.ecolink_closet_left_window
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.master_closet
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'


- id: heat_down_open_laundry_auto
  alias: heat_down_open_laundry_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.laundry_room_window_zone_13
    to: 'on'
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.laundry_room
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: input_select.active_heating_profile
        state: 'PROFILE_AUTO'
      - condition: state
        entity_id: input_select.active_heating_profile
        state: 'PROFILE_A'
#  condition:
#    condition: template 
#    value_template: > 
#      {{ state_attr('climate.living_room', 'status').setpoint_status.setpoint_mode in 'FollowSchedule' }}


- id: heat_up_closed_laundry_auto
  alias: heat_up_closed_laundry_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.laundry_room_window_zone_13
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.laundry_room
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: input_select.active_heating_profile
        state: 'PROFILE_AUTO'
      - condition: state
        entity_id: input_select.active_heating_profile
        state: 'PROFILE_A'


- id: heat_down_open_garage_auto
  alias: heat_down_open_garage_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.ecolink_garage_door
    to: 'on'
    for: 
      minutes: 1
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.garage
      setpoint: 5
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'
#  condition:
#    condition: template 
#    value_template: > 
#      {{ state_attr('climate.living_room', 'status').setpoint_status.setpoint_mode in 'FollowSchedule' }}


- id: heat_up_closed_garage_auto
  alias: heat_up_closed_garage_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.ecolink_garage_door
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.garage
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

- id: heat_up_closed_master_bedroom_auto
  alias: heat_up_closed_master_bedroom_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.master_bedroom_window
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.master_bedroom
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'

- id: heat_up_closed_play_room_auto
  alias: heat_up_closed_play_room_auto
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.play_room_terrace_door
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.dining_room
  condition:
    condition: state
    entity_id: input_select.active_heating_profile
    state: 'PROFILE_AUTO'


- id: heat_down_open_office
  alias: heat_down_open_office
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.office_door
    to: 'on'
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.office_library
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: climate.office_library
    attribute: preset_mode
    state: none

#  condition:
#    condition: template 
#    value_template: > 
#      {{ state_attr('climate.living_room', 'status').setpoint_status.setpoint_mode in 'FollowSchedule' }}


- id: heat_up_closed_office
  alias: heat_up_closed_office
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.office_door
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.office_library
  condition:
    - condition: or
      conditions:
      - condition: and
        conditions:
          - condition: state
            entity_id: input_select.active_heating_profile
            state: 'PROFILE_AUTO'
          - condition: state
            entity_id: input_boolean.working_from_home
            state: 'off'
      - condition: and
        conditions:
          - condition: state
            entity_id: input_boolean.working_from_home
            state: 'on'
          - condition:  time
            before: "10:00:00"
            after: "18:30:00"
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
          - condition: state
            entity_id: input_select.active_heating_profile
            state: 'PROFILE_AUTO'
      - condition: and
        conditions:
          - condition: state
            entity_id: input_boolean.working_from_home
            state: 'on'
          - condition:  time
            weekday:
              - sat
              - sun
          - condition: state
            entity_id: input_select.active_heating_profile
            state: 'PROFILE_AUTO'


- id: heat_down_open_library
  alias: heat_down_open_libary
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.library_door
    to: 'on'
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.office_library
      setpoint: 12
      duration: {"minutes":1439}
  condition:
    condition: state
    entity_id: climate.office_library
    attribute: preset_mode
    state: none

#  condition:
#    condition: template 
#    value_template: > 
#      {{ state_attr('climate.living_room', 'status').setpoint_status.setpoint_mode in 'FollowSchedule' }}


- id: heat_up_closed_libary
  alias: heat_up_closed_library
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.library_door
    to: 'off'
  action:   
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.office_library
  condition:
    - condition: or
      conditions:
      - condition: and
        conditions:
          - condition: state
            entity_id: input_select.active_heating_profile
            state: 'PROFILE_AUTO'
          - condition: state
            entity_id: input_boolean.working_from_home
            state: 'off'
      - condition: and
        conditions:
          - condition: state
            entity_id: input_boolean.working_from_home
            state: 'on'
          - condition:  time
            before: "10:00:00"
            after: "18:30:00"
            weekday:
              - mon
              - tue
              - wed
              - thu
              - fri
          - condition: state
            entity_id: input_select.active_heating_profile
            state: 'PROFILE_AUTO'
      - condition: and
        conditions:
          - condition: state
            entity_id: input_boolean.working_from_home
            state: 'on'
          - condition:  time
            weekday:
              - sat
              - sun
          - condition: state
            entity_id: input_select.active_heating_profile
            state: 'PROFILE_AUTO'

######################################################
# AUTOMATIONS TO ADJUST HEAT BASED ON WEATHER REPORT #
######################################################
# this shit all got replaced by a badass python script
# that runs once a day at 12:30 AM (and again an 12:32 AM 
# to cover a 1 minute window where it would normally cycle the TRV's

- id: set_heat_overrides_for_warm_weather
  alias: set_heat_overrides_for_warm_weather
  initial_state: 'true'
  trigger:
    platform: time
    at: '00:30:00'
  action:
    - service: python_script.set_heat_weather_override

- id: set_heat_overrides_for_warm_weather
  alias: set_heat_overrides_for_warm_weather
  initial_state: 'true'
  trigger:
    platform: time
    at: '00:32:00'
  action:
    - service: python_script.set_heat_weather_override



####################################################
# Special Heating Cases Based on Location or Input #
####################################################

- id: sophie_room_heat_up_if_home
  alias: "Turn up the heat in sophie's room if she's home"
  initial_state: 'true'
  trigger:
    platform: time
    at: '7:50:00'
  condition:    
    condition: and
    conditions:
      - condition: state
        entity_id: 'device_tracker.sophie'
        state: 'home'
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri    
  action:
    - service: evohome.set_zone_override
      data:
        entity_id: climate.sophie_s_room
        setpoint: 23
        duration: {"hours":4, "minutes":20 }

- id: fire_in_fireplace_tomorrow
  alias: "Fire in Fireplace Tomorrow"
  trigger:
    platform: time
    at: '6:00:00'
  condition:    
    condition: state
    entity_id: input_boolean.fire_in_fireplace_tomorrow
    state: 'on'
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.fire_in_fireplace_tomorrow
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.fire_in_fireplace_now

- id: fire_in_fireplace_now
  alias: "Fire in Fireplace Now"
  trigger:
    platform: state
    entity_id: input_boolean.fire_in_fireplace_now
    to: 'on'
  action:
    - service: evohome.set_zone_override
      data:
        entity_id: climate.dining_room
        setpoint: 21
        duration: {"hours":14}
    - service: evohome.set_zone_override
      data:
        entity_id: climate.entrance
        setpoint: 21
        duration: {"hours":14}
    - service: evohome.set_zone_override
      data:
        entity_id: climate.living_room
        setpoint: 21
        duration: {"hours":14}

- id: fire_in_fireplace_now_turned_off
  alias: "Fire in Fireplace Now Off"
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: input_boolean.fire_in_fireplace_now
    to: 'off'
  action:
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.dining_room
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.entrance
    - service: evohome.clear_zone_override
      data:
        entity_id: climate.living_room

- id: working_from_home_now
  alias: "Working From Home Now"
  trigger:
    platform: state
    entity_id: input_boolean.working_from_home
    to: 'on'
  action:
    - choose:
        - conditions: 
            - condition: state
              entity_id: input_select.active_heating_profile
              state: 'PROFILE_AUTO'
          sequence:
            - service: evohome.set_zone_override
              data:
                entity_id: climate.office_library
                setpoint: 23
                duration: {"hours":8}
    - service: switch.turn_on
      data:
        entity_id: switch.alexa_office_do_not_disturb_switch


- id: working_from_home_today
  alias: "Working From Home Today"
  trigger:
    platform: time
    at: '10:00:00'
  condition:    
    - condition: state
      entity_id: input_boolean.working_from_home
      state: 'on'
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri    
  action:
    - choose:
        - conditions: 
            - condition: state
              entity_id: input_select.active_heating_profile
              state: 'PROFILE_AUTO'
          sequence:
            - service: evohome.set_zone_override
              data:
                entity_id: climate.office_library
                setpoint: 23
                duration: {"hours":11,"minutes":40}
    - service: switch.turn_on
      data:
        entity_id: switch.alexa_office_do_not_disturb_switch


- id: end_working_from_home_today
  alias: end_working_from_home_today
  trigger:
    platform: time
    at: '18:30:00'
  condition:    
    condition: time
    weekday:
      - mon
      - tue
      - wed
      - thu
      - fri
  action:
    service: switch.turn_off
    data:
      entity_id: switch.alexa_office_do_not_disturb_switch


#####################################
# Non heating related climate cases #
#####################################

# the /361 minute trigger below is pissing off the parser

- id: notify_windy_weather
  alias: 'Notify About Windy Weather'
  initial_state: 'true'
  mode: single
  trigger:
    hours: '/6'
    platform: time_pattern
  condition:
    condition: template 
    value_template: >
      {{ (states('sensor.dark_sky_wind_gust_1h')|float > 17) or (states('sensor.dark_sky_wind_gust_2h')|float > 17) or (states('sensor.dark_sky_wind_gust_3h')|float > 17) or (states('sensor.dark_sky_wind_gust_4h')|float > 17) or (states('sensor.dark_sky_wind_gust_5h')|float > 17) or (states('sensor.dark_sky_wind_gust_6h')|float > 17) or (states('sensor.dark_sky_wind_gust_7h')|float > 17) or (states('sensor.dark_sky_wind_gust_8h')|float > 17) or (states('sensor.dark_sky_wind_gust_9h')|float > 17) }}
  action:
    - service: notify.mobile_app_sean_iphone_14
      data:
        title: "High Winds Warning"
        data:
          push:
            thread-id: "weather"
      data_template:
        message: >
          {% if states('sensor.dark_sky_wind_gust_1h')|float > 17 %}
          High winds expected in the next hour. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_2h')|float > 17 %}
          High winds expected in 2 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_3h')|float > 17 %}
          High winds expected in 3 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_4h')|float > 17 %}
          High winds expected in 4 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_5h')|float > 17 %}
          High winds expected in 5 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_6h')|float > 17 %}
          High winds expected in 6 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_7h')|float > 17 %}
          High winds expected in 7 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_8h')|float > 17 %}
          High winds expected in 8 hours. Please secure items outside.
          {% elif states('sensor.dark_sky_wind_gust_9h')|float > 17 %}
          High winds expected in 9 hours. Please secure items outside.
          {% else %}
          Error
          {% endif %}

    - delay:
        hours: 5
        minutes: 59

#- id: update_open_window_sensor_and_message
#  alias: update_open_window_sensor_and_message
#  trigger:
#    - platform: time_pattern
#      minutes: '/5'
#  action:
#    - service: homeassistant.update_entity
#      entity_id: binary_sensor.open_window_making_house_cold
#      
#- id: update_open_window_cold_sensor
#  alias: update_open_window_cold_sensor
#  trigger:
#    - platform: state
#      entity_id: 
#        - binary_sensor.back_door
#        - binary_sensor.sebastians_room_left_window
#        - binary_sensor.sophies_room_ceiling_window
#        - binary_sensor.ecolink_closet_left_window
#        - binary_sensor.laundry_room_window_zone_13
#        - binary_sensor.ecolink_garage_door
#        - binary_sensor.windows_1st_floor_zone_2
#        - binary_sensor.master_bedroom_window
#        - binary_sensor.office_door
#        - binary_sensor.library_door
#    - platform: homeassistant
#      event: start
#  action:
#    - delay: '00:00:01'
#    - service: homeassistant.update_entity
#      entity_id: binary_sensor.open_window_making_house_cold
#    
#- id: update_open_window_cold_message
#  alias: update_open_window_cold_message
#  trigger:
#    - platform: state
#      entity_id: 
#        - binary_sensor.back_door
#        - binary_sensor.sebastians_room_left_window
#        - binary_sensor.sophies_room_ceiling_window
#        - binary_sensor.ecolink_closet_left_window
#        - binary_sensor.laundry_room_window_zone_13
#        - binary_sensor.ecolink_garage_door
#        - binary_sensor.windows_1st_floor_zone_2
#        - binary_sensor.master_bedroom_window
#        - binary_sensor.office_door
#        - binary_sensor.library_door
#    - platform: homeassistant
#      event: start
#  action: 
#    - service: python_script.set_open_window_message
#      data:
#        message_type: cold
#
#- id: update_open_window_hot_sensor
#  alias: update_open_window_hot_sensor
#  trigger:
#    - platform: state
#      entity_id: 
#        - binary_sensor.back_door
#        - binary_sensor.sebastians_room_left_window
#        - binary_sensor.sophies_room_ceiling_window
#        - binary_sensor.ecolink_closet_left_window
#        - binary_sensor.laundry_room_window_zone_13
#        - binary_sensor.ecolink_garage_door
#        - binary_sensor.windows_1st_floor_zone_2
#        - binary_sensor.master_bedroom_window
#        - binary_sensor.office_door
#        - binary_sensor.library_door
#    - platform: homeassistant
#      event: start
#  action:
#    - delay: '00:00:01'
#    - service: homeassistant.update_entity
#      entity_id: binary_sensor.open_window_making_house_hot
#    
# - id: update_open_window_hot_message
#  alias: update_open_window_hot_message
#  trigger:
#    - platform: state
#      entity_id: 
#        - binary_sensor.back_door
#        - binary_sensor.sebastians_room_left_window
#        - binary_sensor.sophies_room_ceiling_window
#        - binary_sensor.ecolink_closet_left_window
#        - binary_sensor.laundry_room_window_zone_13
#        - binary_sensor.ecolink_garage_door
#        - binary_sensor.windows_1st_floor_zone_2
#        - binary_sensor.master_bedroom_window
#        - binary_sensor.office_door
#        - binary_sensor.library_door
#    - platform: homeassistant
#      event: start   
#  action: 
#    - service: python_script.set_open_window_message
#      data:
#        message_type: hot

# - id: update_open_window_aqi_sensor
#  alias: update_open_window_aqi_sensor
#  trigger:
#    - platform: state
#      entity_id: 
#        - binary_sensor.back_door
#        - binary_sensor.sebastians_room_left_window
#        - binary_sensor.sophies_room_ceiling_window
#        - binary_sensor.ecolink_closet_left_window
#        - binary_sensor.laundry_room_window_zone_13
#        - binary_sensor.ecolink_garage_door
#        - binary_sensor.windows_1st_floor_zone_2
#        - binary_sensor.master_bedroom_window
#        - binary_sensor.office_door
#        - binary_sensor.library_door
#    - platform: homeassistant
#      event: start
#  action:
#    - delay: '00:00:01'
#    - service: homeassistant.update_entity
#      entity_id: binary_sensor.open_window_letting_pollution_in

# - id: update_open_window_aqi_message
#  alias: update_open_window_aqi_message
#  trigger:
#    - platform: state
#      entity_id: 
#        - binary_sensor.back_door
#        - binary_sensor.sebastians_room_left_window
#        - binary_sensor.sophies_room_ceiling_window
#        - binary_sensor.ecolink_closet_left_window
#        - binary_sensor.laundry_room_window_zone_13
#        - binary_sensor.ecolink_garage_door
#        - binary_sensor.windows_1st_floor_zone_2
#        - binary_sensor.master_bedroom_window
#        - binary_sensor.office_door
#        - binary_sensor.library_door
#    - platform: homeassistant
#      event: start
#  action: 
#    - service: python_script.set_open_window_message
#      data:
#        message_type: aqi



- id: update_open_window_message
  alias: update_open_window_message
  trigger:
  - platform: state
    entity_id: 
      - binary_sensor.back_door
      - binary_sensor.sebastians_room_left_window
      - binary_sensor.sophies_room_ceiling_window
      - binary_sensor.ecolink_closet_left_window
      - binary_sensor.laundry_room_window_zone_13
      - binary_sensor.ecolink_garage_door
      - binary_sensor.windows_1st_floor_zone_2
      - binary_sensor.master_bedroom_window
      - binary_sensor.office_door
      - binary_sensor.library_door
  - platform: state
    entity_id: binary_sensor.open_window_letting_pollution_in
    to: 'on'
  - platform: state
    entity_id: binary_sensor.open_window_making_house_cold
    to: 'on'
  - platform: state
    entity_id: binary_sensor.open_window_making_house_hot
    to: 'on'
  action: 
  - service: python_script.set_open_window_message

- id: update_open_window_sensor
  alias: update_open_window_sensor
  trigger:
    - platform: state
      entity_id: 
        - binary_sensor.back_door
        - binary_sensor.sebastians_room_left_window
        - binary_sensor.sophies_room_ceiling_window
        - binary_sensor.ecolink_closet_left_window
        - binary_sensor.laundry_room_window_zone_13
        - binary_sensor.ecolink_garage_door
        - binary_sensor.windows_1st_floor_zone_2
        - binary_sensor.master_bedroom_window
        - binary_sensor.office_door
        - binary_sensor.library_door
    - platform: state
      entity_id: binary_sensor.open_window_letting_pollution_in
    - platform: state
      entity_id: binary_sensor.open_window_making_house_cold
    - platform: state
      entity_id: binary_sensor.open_window_making_house_hot
    - platform: numeric_state
      entity_id: sensor.home_air_quality
      above: 50
    - platform: numeric_state
      entity_id: sensor.home_air_quality
      below: 50
    - platform: numeric_state
      entity_id: sensor.tempest_st_00023475_temperature
      above: 18
    - platform: numeric_state
      entity_id: sensor.tempest_st_00023475_temperature
      below: 18
    - platform: numeric_state
      entity_id: sensor.tempest_st_00023475_temperature
      above: 26
    - platform: numeric_state
      entity_id: sensor.tempest_st_00023475_temperature
      below: 26
    - platform: numeric_state
      entity_id: sensor.dark_sky_daytime_high_temperature_0d
      above: 30
    - platform: numeric_state
      entity_id: sensor.dark_sky_daytime_high_temperature_0d
      below: 30
    - platform: homeassistant
      event: start
  action:
    - delay: '00:00:01'
    - service: homeassistant.update_entity
      entity_id: binary_sensor.open_window_making_air_problem
    

- id: notify_home_aqi_high
  alias: notify_home_aqi_high
  initial_state: 'true'
  trigger:
    platform: numeric_state
    entity_id: sensor.home_air_quality
    above: 55
    for: 
      minutes: 5
  condition:
    condition: state
    entity_id: input_select.last_inside_aqi_notification
    state: 'Good' 
  action:
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: notify.mobile_app_sean_iphone_14
              data:
                title: "Home indoor air quality is poor"
                message: "The indoor Air Quality Index at home is currently {{states('sensor.home_air_quality')}}. Turn on an air purifier."
                data:
                  push:
                    thread-id: "weather"
            - service: input_select.select_option
              data:
                entity_id: input_select.last_inside_aqi_notification
                option: 'Bad'
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.alena_s_iphone
              state: 'home'
          sequence:
            - service: notify.mobile_app_alena_s_iphone
              data:
                title: "Home indoor air quality is poor"
                message: "The indoor Air Quality Index at home is currently {{states('sensor.home_air_quality')}}. Turn on an air purifier."             
                data:
                  push:
                    thread-id: "weather"
            - service: input_select.select_option
              data:
                entity_id: input_select.last_inside_aqi_notification
                option: 'Bad'
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: mqtt.publish
              data:
                topic: !secret genesys_5490_notify_topic
                payload: !secret genesys_5490_inside_aqi_poor
    - service: input_select.select_option
      data:
        entity_id: input_select.last_inside_aqi_notification
        option: 'Bad'

#              - condition: template
#                value_template: '{{((as_timestamp(states.automation.notify_home_aqi_low.attributes.last_triggered) - as_timestamp(states.automation.notify_home_aqi_high.attributes.last_triggered)  | default(-1)) | int < 0)}}'


- id: notify_home_aqi_low
  alias: notify_home_aqi_low
  initial_state: 'true'
  trigger:
    platform: numeric_state
    entity_id: sensor.home_air_quality
    below: 45
    for: 
      minutes: 5
  condition:
    condition: state
    entity_id: input_select.last_inside_aqi_notification
    state: 'Bad'
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: notify.mobile_app_sean_iphone_14
              data:
                title: "Home indoor air quality is good again"
                message: "The indoor Air Quality Index at home is currently {{states('sensor.home_air_quality')}}."             
                data:
                  push:
                    thread-id: "weather"

    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.alena_s_iphone
              state: 'home'
          sequence:
            - service: notify.mobile_app_alena_s_iphone
              data:
                title: "Home indoor air quality is good again"
                message: "The indoor Air Quality Index at home is currently {{states('sensor.home_air_quality')}}."             
                data:
                  push:
                    thread-id: "weather"
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: mqtt.publish
              data:
                topic: !secret genesys_5490_notify_topic
                payload: !secret genesys_5490_inside_aqi_good
    - service: input_select.select_option
      data:
        entity_id: input_select.last_inside_aqi_notification
        option: 'Good'

#              - condition: template
#                value_template: '{{((as_timestamp(states.automation.notify_home_aqi_low.attributes.last_triggered) - as_timestamp(states.automation.notify_home_aqi_high.attributes.last_triggered)  | default(-1)) | int < 0)}}'


- id: notify_hlubocepy_aqi_high
  alias: notify_hlubocepy_aqi_high
  initial_state: 'true'
  trigger:
    platform: numeric_state
    entity_id: sensor.hlubocepy_air_quality
    above: 70
    for: 
      minutes: 5
  condition:
    condition: state
    entity_id: input_select.last_outside_aqi_notification
    state: 'Good'
  action:
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: notify.mobile_app_sean_iphone_14
              data:
                title: "Home outdoor air quality is poor"
                message: "The outdoor Air Quality Index at home is currently {{states('sensor.hlubocepy_air_quality')}}. Turn on an air purifier."
                data:
                  push:
                    thread-id: "weather"
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.alena_s_iphone
              state: 'home'
          sequence:
            - service: notify.mobile_app_alena_s_iphone
              data:
                title: "Home outdoor air quality is poor"
                message: "The outdoor Air Quality Index at home is currently {{states(' sensor.hlubocepy_air_quality')}}. Turn on an air purifier."             
                data:
                  push:
                    thread-id: "weather"
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: mqtt.publish
              data:
                topic: !secret genesys_5490_notify_topic
                payload: !secret genesys_5490_outside_aqi_poor
    - service: input_select.select_option
      data:
        entity_id: input_select.last_outside_aqi_notification
        option: 'Bad'

#              - condition: template
#                value_template: '{{((as_timestamp(states.automation.notify_hlubocepy_aqi_low.attributes.last_triggered) - as_timestamp(states.automation.notify_hlubocepy_aqi_high.attributes.last_triggered)  | default(-1)) | int > 0)}}'


- id: notify_hlubocepy_aqi_low
  alias: notify_hlubocepy_aqi_low
  initial_state: 'true'
  trigger:
    platform: numeric_state
    entity_id: sensor.hlubocepy_air_quality
    below: 50
    for: 
      minutes: 5
  condition:
    condition: state
    entity_id: input_select.last_outside_aqi_notification
    state: 'Bad'
  action:
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: notify.mobile_app_sean_iphone_14
              data:
                title: "Home outdoor air quality is good again"
                message: "The outdoor Air Quality Index at home is currently {{states('sensor.hlubocepy_air_quality')}}."             
                data:
                  push:
                    thread-id: "weather"
            - service: input_select.select_option
              data:
                entity_id: input_select.last_outside_aqi_notification
                option: 'Good'
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.alena_s_iphone
              state: 'home'
          sequence:
            - service: notify.mobile_app_alena_s_iphone
              data:
                title: "Home outdoor air quality is good again"
                message: "The outdoor Air Quality Index at home is currently {{states('sensor.hlubocepy_air_quality')}}."             
                data:
                  push:
                    thread-id: "weather"
            - service: input_select.select_option
              data:
                entity_id: input_select.last_outside_aqi_notification
                option: 'Good'
    - choose:
        - conditions: 
            - condition: state
              entity_id: device_tracker.seans_iphone_14
              state: 'home'
          sequence:
            - service: mqtt.publish
              data:
                topic: !secret genesys_5490_notify_topic
                payload: !secret genesys_5490_outside_aqi_good
    - service: input_select.select_option
      data:
        entity_id: input_select.last_outside_aqi_notification
        option: 'Good'

- id: raining_state_change_timer
  alias: raining_state_change_timer
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: binary_sensor.weatherflow_is_raining  
      to: 'off'
  action:
    service: timer.start
    data:
      entity_id: timer.raining_state_change_timer

- id: notify_its_raining
  alias: notify_its_raining
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.weatherflow_is_raining
    to: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: timer.raining_state_change_timer
          state: 'idle'
        - condition: template
          value_template: "{{ not is_state('sensor.sean_location', 'Traveling') }}"
  action:
    - service: notify.mobile_app_sean_iphone_14
      data:
        title: "It's Raining"
        message: "It's raining outside at home"
        data:
          push:
            thread-id: "weather"
            
#    condition: template
#    value_template: '{{ (((as_timestamp(now())-as_timestamp(states.binary_sensor._raining.last_changed)|int) > 299) }}'



#  action:
#    - choose:
#        - conditions: 
#            - condition: template
#              value_template: "{{ not is_state('device_tracker.seans_iphone_14', 'Traveling') }}"
#          sequence:
#            - service: notify.mobile_app_sean_iphone_14
#              data:
#                title: "It's Raining"
#                message: "It's raining outside at home"
#                data:
#                  push:
#                    thread-id: "weather"
#    - service: notify.mobile_app_alena_s_iphone
#      data:
#        title: "It's Raining"
#        message: "It's raining outside at home"
#        data:
#          push:
#            thread-id: "weather"
#    - service: notify.mobile_app_sophies_iphone_se
#      data:
#        title: "It's Raining"
#        message: "It's raining outside at home"
#        data:
#          push:
#            thread-id: "weather"


- id: notify_stopped_raining
  alias: notify_stopped_raining
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.weatherflow_is_raining
    to: 'off'
    for: "00:04:59"
  action:
    - choose:
        - conditions: 
            - condition: template
              value_template: "{{ not is_state('device_tracker.seans_iphone_14', 'Traveling') }}"
          sequence:
            - service: notify.mobile_app_sean_iphone_14
              data:
                title: "Stopped Raining"
                message: "It stopped raining outside at home. Total rain today: {{states('sensor.weatherflow_precipitation_today')}} millimeters over {{states('sensor.weatherflow_precipitation_duration_today')}} minutes of rain"
                data:
                  push:
                    thread-id: "weather"
    - service: notify.mobile_app_alena_s_iphone
      data:
        title: "It Stopped Raining"
        message: "It stopped raining outside at home. Total rain today: {{states('sensor.weatherflow_precipitation_today')}} millimeters over {{states('sensor.weatherflow_precipitation_duration_today')}} minutes of rain"
        data:
          push:
            thread-id: "weather"
    - service: notify.mobile_app_sophies_iphone_se
      data:
        title: "It Stopped Raining"
        message: "It stopped raining outside at home. Total rain today: {{states('sensor.weatherflow_precipitation_today')}} millimeters over {{states('sensor.weatherflow_precipitation_duration_today')}} minutes of rain."
        data:
          push:
            thread-id: "weather"

- id: notify_its_raining_with_roof_window_open
  alias: notify_its_raining_with_roof_window_open
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: binary_sensor.weatherflow_is_raining
    to: 'on'
  action:
    - choose:
        - conditions: 
            - condition: state
              entity_id: binary_sensor.sophies_room_ceiling_window
              state: 'on'
          sequence:
            - service: notify.whole_family
              data:
                title: "!!Open Window and Rain!!"
                message: "Sophie's window is open and it's raining! Close it!"
                data:
                  push:
                    sound:
                      name: "Update.caf"
                      critical: 1
                      volume: 1.0
            - service: script.house_announcement
              data:
                message: "Attention! Sophie's window is open and it is raining outside! Please close it now!"
            - service: script.announce_its_raining_with_sophie_roof_window_open_office
    - choose:
        - conditions: 
            - condition: state
              entity_id: binary_sensor.sebastians_room_left_window
              state: 'on'
          sequence:
            - service: notify.whole_family
              data:
                title: "!!Open Window and Rain!!"
                message: "Sebastians's window is open and it's raining! Close it!"
                data:
                  push:
                    sound:
                      name: "Update.caf"
                      critical: 1
                      volume: 1.0
            - service: script.house_announcement
              data:
                message: "Attention! Sebastian's window is open and it is raining outside! Please close it now!"
            - service: script.announce_its_raining_with_sebastian_roof_window_open_office


- id: update_rain_sensor
  alias: update_rain_sensor
  initial_state: 'true'
  trigger:
    platform: time_pattern
    minutes: "/1"
  action:
    service: homeassistant.update_entity
    target:
      entity_id: sensor.rain_sensor

- id: update_wind_timers
  alias: update_wind_timers
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: sensor.tempest_st_00023475_wind_speed
  action:
    - choose:
        - conditions: 
            - condition: numeric_state
              entity_id: sensor.tempest_st_00023475_wind_speed
#              above: 8
              above: 14
          sequence:
            - service: timer.start
              target:
                entity_id: timer.medium_wind_timer
    - choose:
        - conditions: 
            - condition: numeric_state
              entity_id: sensor.tempest_st_00023475_wind_speed
              above: 21
#              above: 13
          sequence:
            - service: timer.start
              target:
                entity_id: timer.high_wind_timer
    - choose:
        - conditions: 
            - condition: numeric_state
              entity_id: sensor.tempest_st_00023475_wind_speed
              above: 28
#              above: 17
          sequence:
            - service: timer.start
              target:
                entity_id: timer.very_high_wind_timer
    - choose:
        - conditions: 
            - condition: numeric_state
              entity_id: sensor.tempest_st_00023475_wind_speed
              above: 46
#              above: 25
          sequence:
            - service: timer.start
              target:
                entity_id: timer.dangerous_wind_timer


# - id: update_medium_wind_timer
#   alias: update_medium_wind_timer
#   initial_state: 'true'
#   trigger:
#     platform: numeric_state
#     entity_id: sensor._wind_speed_realtime
#     above: 4
#   action:
#     service: timer.start
#     target:
#       entity_id: timer.medium_wind_timer

# - id: update_high_wind_timer
#   alias: update_high_wind_timer
#   initial_state: 'true'
#   trigger:
#     platform: numeric_state
#     entity_id: sensor._wind_speed_realtime
#     above: 9
#   action:
#     service: timer.start
#     target:
#       entity_id: timer.high_wind_timer

# - id: update_very_high_wind_timer
#   alias: update_very_high_wind_timer
#   initial_state: 'true'
#   trigger:
#     platform: numeric_state
#     entity_id: sensor._wind_speed_realtime
#     above: 14
#   action:
#     service: timer.start
#     target:
#       entity_id: timer.very_high_wind_timer

# - id: update_dangerous_wind_timer
#   alias: update_dangerous_wind_timer
#   initial_state: 'true'
#   trigger:
#     platform: numeric_state
#     entity_id: sensor._wind_speed_realtime
#     above: 19
#   action:
#     service: timer.start
#     target:
#       entity_id: timer.dangerous_wind_timer



- id: notify_lightning
  alias: notify_lightning
  initial_state: 'true'
  mode: single
  trigger:
    platform: state
    entity_id: sensor.weatherflow_last_lightning_strike
  condition:
    condition: and
    conditions: 
      - condition: state
        entity_id: timer.lightning_warning_wait
        state: 'idle'
      - condition: numeric_state
        entity_id: sensor.weatherflow_last_lightning_strike_distance
        below: 11
  action:
    - choose:
        - conditions: 
            - condition: template
              value_template: "{{ not is_state('device_tracker.seans_iphone_14', 'Traveling') }}"
          sequence:
            - service: notify.mobile_app_sean_iphone_14
              data:
                title: "Lightning Warning"
                message: "Lightning has been detected outside. Most recent strike was {{states('sensor.weatherflow_last_lightning_strike_distance')}} km away. There have been {{states('sensor.weatherflow_lightning_strike_count_last_hour')}} lightning strikes in the last hour within a 50km radius of home."
                data:
                  push:
                    thread-id: "weather"
    - service: notify.mobile_app_alena_s_iphone
      data:
        title: "Lightning Warning"
        message: "Lightning has been detected outside. Most recent strike was {{states('sensor.weatherflow_last_lightning_strike_distance')}} km away. There have been {{states('sensor.weatherflow_lightning_strike_count_last_hour')}} lightning strikes in the last hour within a 50km radius of home."
        data:
          push:
            thread-id: "weather"
    - service: notify.mobile_app_sophies_iphone_se
      data:
        title: "Lightning Warning"
        message: "Lightning has been detected outside. Most recent strike was {{states('sensor.weatherflow_last_lightning_strike_distance')}} km away. There have been {{states('sensor.weatherflow_lightning_strike_count_last_hour')}} lightning strikes in the last hour within a 50km radius of home."
        data:
          push:
            thread-id: "weather"
    - service: timer.start
      data:
        entity_id: timer.lightning_warning_wait
 

- id: restart_lightning_timer
  alias: restart_lightning_timer
  initial_state: 'true'
  trigger:
    - platform: numeric_state
      entity_id: sensor.weatherflow_last_lightning_strike_distance
      below: 20
  action:
    - service: timer.start
      data:
        entity_id: timer.lightning_keepalive
    - service: input_text.set_value
      target:
        entity_id: input_text.last_close_lightning_distance
      data_template:
        value: >
          {{states('sensor.weatherflow_last_lightning_strike_distance')}}
    - service: input_text.set_value
      target:
        entity_id: input_text.last_close_lightning_time
      data_template:
        value: >
          {{states('sensor.weatherflow_last_lightning_strike')}}

- id: set_sophie_ac_to_23
  alias: set_sophie_ac_to_23
  initial_state: 'true'
  trigger:
    platform: state
    entity_id: climate.sophie_s_room_ac
    to: 'cool'
  action:
    service: climate.set_temperature
    target:
      entity_id: climate.sophie_s_room_ac
    data:
      temperature: 23

- id: turn_off_sophie_ac_after_40_minutes
  alias: turn_off_sophie_ac_after_40_minutes
  initial_state: 'true'
  mode: single
  trigger:
    entity_id: binary_sensor.sophies_room_zone_10
    to: 'off'
    for: 
      minutes: 40
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: climate.sophie_s_room_ac
        state: 'cool'
      - condition:  time
        after: "8:00:00"
        before: "20:00:00"
  action:
    service: climate.turn_off
    target:
      entity_id: climate.sophie_s_room_ac

- id: send_notification_for_rainy_or_snowy_day
  alias: send_notification_for_rainy_or_snowy_day
  initial_state: 'true'
  trigger:
    platform: time
    at: '11:45:00'
  condition:
    condition: template 
    value_template: >
      {{ (states('sensor.dark_sky_precip_intensity_1h')|float > 0.05)
             and (states('sensor.dark_sky_precip_intensity_2h')|float > 0.05)
             and (states('sensor.dark_sky_precip_intensity_3h')|float > 0.05)
             and (states('sensor.dark_sky_precip_intensity_4h')|float > 0.05)
             and (states('sensor.dark_sky_precip_intensity_5h')|float > 0.05)
             and (states('sensor.dark_sky_precip_intensity_6h')|float > 0.05)
             and (states('sensor.dark_sky_precip_intensity_7h')|float > 0.05)) }}
  action:
    - service: notify.mobile_app_sean_iphone_14
      data:
        title: "{{sensor.dark_sky_precip_0d}} warning"
        data:
          push:
            thread-id: "weather"
      data_template:
        message: >
          {% if states('sensor.dark_sky_precip_intensity_1h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in the next hour. Please dress appropriately.
          {% elif states('sensor.dark_sky_precip_intensity_2h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in 2 hours. Please dress appropriately.
          {% elif states('sensor.dark_sky_precip_intensity_3h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in 3 hours. Please dress appropriately.
          {% elif states('sensor.dark_sky_precip_intensity_4h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in 4 hours. Please dress appropriately.
          {% elif states('sensor.dark_sky_precip_intensity_5h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in 5 hours. Please dress appropriately.
          {% elif states('sensor.dark_sky_precip_intensity_6h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in 6 hours. Please dress appropriately.
          {% elif states('sensor.dark_sky_precip_intensity_7h')|float > 17 %}
          {{sensor.dark_sky_precip_0d}} expected in 7 hours. Please dress appropriately.
          {% else %}
          Error
          {% endif %}


- id: turn_off_ac_light_at_night
  alias: turn_off_ac_light_at_night
  initial_state: 'false'
  trigger:
    - platform: state
      entity_id: climate.sophie_s_room_ac
      id: Sophies Room
    - platform: state
      entity_id: climate.sebastian_s_room_ac
      id: Sebastians Room
    - platform: state
      entity_id: climate.master_bedroom_ac
      id: Master Bedoom
  condition: []
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: Sophies Room
            - condition: time
              before: "08:00:00"
              after: "7:30:00"
          sequence:
            - service: select.select_option
              data:
                option: 'off'
              target:
                entity_id: select.sophie_s_room_ac_light
    - choose:
        - conditions:
            - condition: trigger
              id: Sebastians Room
            - condition: time
              before: "08:00:00"
              after: "7:30:00"
          sequence:
            - service: select.select_option
              data:
                option: 'off'
              target:
                entity_id: select.sebastian_s_room_ac_light
    - choose:
        - conditions:
            - condition: trigger
              id: Master Bedroom
            - condition: time
              before: "08:00:00"
              after: "7:30:00"
          sequence:
            - service: select.select_option
              data:
                option: 'off'
              target:
                entity_id: select.master_bedroom_ac_light



- id: towel_warmer_turn_off_timer
  alias: towel_warmer_turn_off_timer
  initial_state: 'true'
  trigger:
    - platform: state
      entity_id: switch.master_bath_towel_warmer
      to: 'on'
      for: 
        hours: 3
  action:
    service: switch.turn_off
    data:
      entity_id: switch.master_bath_towel_warmer

- id: sebastian_home_weekday_nap
  alias: sebastian_home_weekday_nap
  initial_state: 'true'
  trigger:
    platform: time
    at: '13:30:00'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.sebastian_home_weekday
          state: 'on'
        - condition:  time
          weekday:
            - mon
            - tue
            - wed
            - thu
            - fri
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.sebastian_s_room
      setpoint: 21
      duration: {"minutes":195}

- id: sophie_home_weekday
  alias: sophie_home_weekday
  initial_state: 'true'
  trigger:
    platform: time
    at: '8:00:00'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.sophie_home_weekday
          state: 'on'
        - condition:  time
          weekday:
            - mon
            - tue
            - wed
            - thu
            - fri
  action:
    service: evohome.set_zone_override
    data:
      entity_id: climate.sophie_s_room
      setpoint: 22
      duration: {"hours":13}

